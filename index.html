<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wrike Projects</title>

  <style>
    :root{
      --bg: #0b0f17;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card: rgba(0,0,0,.04);
        --card2: rgba(0,0,0,.06);
        --text: rgba(0,0,0,.88);
        --muted: rgba(0,0,0,.58);
        --border: rgba(0,0,0,.10);
        --shadow: 0 10px 25px rgba(0,0,0,.12);
      }
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 0%, rgba(124,92,255,.28), transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, rgba(35,198,255,.22), transparent 50%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{ padding: 18px; max-width: 980px; margin: 0 auto; }
    .shell{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
    }
    header{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }
    .title h1{ margin:0; font-size: 16px; letter-spacing:.2px; font-weight: 700; }
    .grid{ padding: 16px; display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 14px;
      min-height: 90px;
      grid-column: span 12;
    }
    .label{ font-size: 12px; color: var(--muted); }
    .projects-list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .projects-list::-webkit-scrollbar{ width: 10px; }
    .projects-list::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
    }
    .projects-list::-webkit-scrollbar-track{ background: transparent; }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .text{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .text .main{
      font-size: 13px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .text .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .actions{ display:flex; align-items:center; gap: 8px; }
    .btn{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      white-space: nowrap;
      text-decoration: none;
      cursor: pointer;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-danger{ color: rgba(255,200,200,.9); }
    .tag-muted{ opacity:.7; }
    .errorBox{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .errorBox a{ color: inherit; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <header>
        <div class="title">
          <h1>Wrike Projects</h1>
        </div>
      </header>

      <div class="grid">
        <div class="card">
          <div class="label">My Wrike Projects</div>
          <div id="wrikeProjects" class="projects-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const workerBase = "https://wrike-proxy.dustinjsmith.workers.dev";

    function buildListUrl() {
      const u = new URL(workerBase);
      u.pathname = "/"; // ensure it always hits the Worker route
      u.searchParams.set("pmField", "Project Manager");
      u.searchParams.set("assignedField", "Assigned");
      u.searchParams.set("limit", "25");
      return u.toString();
    }

    function getAdminKey() {
      const existing = sessionStorage.getItem("wrike_adminKey");
      if (existing) return existing;
      const k = prompt("Enter admin key to move repo pages to Project Archive:");
      if (!k) return "";
      sessionStorage.setItem("wrike_adminKey", k);
      return k;
    }

    // Uses GET to avoid CORS preflight headaches in embedded iframes
    async function archiveRepo(projectId, projectTitle, btnEl, metaEl) {
      const ok = confirm(`Move "${projectTitle}" repo page to Project Archive?`);
      if (!ok) return;

      const adminKey = getAdminKey();
      if (!adminKey) return;

      btnEl.disabled = true;
      btnEl.textContent = "Archiving…";

      try {
        const u = new URL(workerBase);
        u.pathname = "/";
        u.searchParams.set("action", "archiveRepo");
        u.searchParams.set("projectId", projectId);
        u.searchParams.set("adminKey", adminKey);

        const res = await fetch(u.toString(), { cache: "no-store" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.error) {
          btnEl.disabled = false;
          btnEl.textContent = "Archive";
          alert("Archive failed: " + (data.error || `HTTP ${res.status}`));
          return;
        }

        btnEl.textContent = "Archive";
        btnEl.classList.add("tag-muted");
        btnEl.title = "Moved to Project Archive";

        if (metaEl) {
          const curr = (metaEl.textContent || "").trim();
          if (!curr.includes("Repo archived")) {
            metaEl.textContent = curr ? `${curr} • Repo archived` : "Repo archived";
          }
        }
      } catch (e) {
        btnEl.disabled = false;
        btnEl.textContent = "Archive";
        alert("Archive failed: " + String(e));
      }
    }

    async function loadWrikeProjects(){
      const el = document.getElementById("wrikeProjects");
      const listUrl = buildListUrl();
      el.textContent = "Loading…";

      try {
        const res = await fetch(listUrl, { cache: "no-store" });
        const data = await res.json();

        if (!res.ok || data.error) {
          el.innerHTML = `
            <div class="errorBox">
              Could not load projects.<br/>
              Status: ${res.status}<br/>
              Error: ${(data.error || "Unknown")}<br/>
              Test the Worker URL: <a href="${listUrl}" target="_blank" rel="noreferrer">${listUrl}</a>
            </div>`;
          return;
        }

        if (!data.projects?.length) {
          el.textContent = "No matching projects found.";
          return;
        }

        el.innerHTML = data.projects.slice(0, 25).map(p => {
          const metaParts = [];
          if (p.endDate) metaParts.push(`End ${p.endDate}`);
          if (p.repoArchived) metaParts.push("Repo archived");
          const meta = metaParts.join(" • ");

          const repoBtn = p.repoUrl
            ? `<a class="btn" href="${p.repoUrl}" target="_blank" rel="noreferrer">Repo</a>`
            : `<button class="btn" disabled>Repo</button>`;

          const archiveDisabled = p.repoArchived ? "disabled" : "";
          const archiveMuted = p.repoArchived ? "tag-muted" : "";

          const safeTitle = (p.title || "(Untitled project)")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");

          return `
            <div class="item">
              <div class="left">
                <div class="text">
                  <div class="main">${safeTitle}</div>
                  <div class="meta" data-meta="${p.id}">${meta || ""}</div>
                </div>
              </div>
              <div class="actions">
                ${repoBtn}
                <a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Open</a>
                <button class="btn btn-danger ${archiveMuted}" ${archiveDisabled}
                        data-archive="${p.id}" data-title="${safeTitle}">Archive</button>
              </div>
            </div>
          `;
        }).join("");

        el.querySelectorAll("button[data-archive]").forEach(btn => {
          btn.addEventListener("click", () => {
            const projectId = btn.dataset.archive;
            const projectTitle = btn.dataset.title || "this project";
            const metaEl = el.querySelector(`[data-meta="${projectId}"]`);
            archiveRepo(projectId, projectTitle, btn, metaEl);
          });
        });

      } catch (e) {
        el.innerHTML = `
          <div class="errorBox">
            <b>Failed to fetch</b><br/>
            This usually means the Worker URL is unreachable, blocked by CORS, or returning an error page without CORS headers.<br/><br/>
            Test the Worker URL in a new tab:<br/>
            <a href="${buildListUrl()}" target="_blank" rel="noreferrer">${buildListUrl()}</a><br/><br/>
            Details: ${String(e)}
          </div>`;
      }
    }

    loadWrikeProjects();
  </script>
</body>
</html>
