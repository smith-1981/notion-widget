<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wrike Projects</title>

  <style>
    :root{
      --bg: #0b0f17;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --danger: rgba(255,200,200,.9);
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card: rgba(0,0,0,.04);
        --card2: rgba(0,0,0,.06);
        --text: rgba(0,0,0,.88);
        --muted: rgba(0,0,0,.58);
        --border: rgba(0,0,0,.10);
        --shadow: 0 10px 25px rgba(0,0,0,.12);
        --danger: rgba(170,40,40,.9);
      }
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 0%, rgba(124,92,255,.28), transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, rgba(35,198,255,.22), transparent 50%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{ padding: 18px; max-width: 980px; margin: 0 auto; }

    .shell{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
    }

    header{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .title h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      font-weight: 700;
    }

    .admin{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .admin input{
      width: 180px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size: 12px;
    }

    .admin .hint{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .grid{
      padding: 16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 14px;
      min-height: 90px;
      grid-column: span 12;
    }

    .label{ font-size: 12px; color: var(--muted); }

    .projects-list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .projects-list::-webkit-scrollbar{ width: 10px; }
    .projects-list::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
    }
    .projects-list::-webkit-scrollbar-track{ background: transparent; }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
    }

    .left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .text{ display:flex; flex-direction:column; gap:2px; min-width: 0; }

    .text .main{
      font-size: 13px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .text .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .text .statusline{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .actions{ display:flex; align-items:center; gap: 8px; }

    .btn{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      white-space: nowrap;
      text-decoration: none;
      cursor: pointer;
      user-select: none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-danger{ color: var(--danger); }
    .muted{ opacity: .7; }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(520px, 100%);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card2), var(--card));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal h2{
      margin: 0 0 8px;
      font-size: 14px;
    }
    .modal p{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .modal .row{
      display:flex;
      gap: 8px;
      justify-content:flex-end;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <header>
        <div class="title">
          <h1>Wrike Projects</h1>
        </div>

        <div class="admin">
          <input id="adminKey" type="password" placeholder="Admin key (for Archive)" />
          <span id="adminHint" class="hint"></span>
        </div>
      </header>

      <div class="grid">
        <div class="card">
          <div class="label">My Wrike Projects</div>
          <div id="wrikeProjects" class="projects-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="modalTitle">Archive repo page?</h2>
      <p id="modalText"></p>
      <div class="row">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalOk" class="btn btn-danger">Archive</button>
      </div>
    </div>
  </div>

  <script>
    const workerBase = "https://wrike-proxy.dustinjsmith.workers.dev";
    const STORAGE_KEY = "wrike_adminKey";

    function buildListUrl() {
      const u = new URL(workerBase);
      u.pathname = "/";
      u.searchParams.set("pmField", "Project Manager");
      u.searchParams.set("assignedField", "Assigned");
      u.searchParams.set("limit", "25");
      return u.toString();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // Admin key input
    const adminInput = document.getElementById("adminKey");
    const adminHint = document.getElementById("adminHint");

    function refreshAdminHint() {
      const v = (adminInput.value || "").trim();
      adminHint.textContent = v ? "Key set" : "Key required for Archive";
    }

    adminInput.value = localStorage.getItem(STORAGE_KEY) || "";
    refreshAdminHint();

    adminInput.addEventListener("input", () => {
      localStorage.setItem(STORAGE_KEY, adminInput.value);
      refreshAdminHint();
    });

    function getAdminKey() {
      const v = (adminInput.value || "").trim();
      return v;
    }

    // Modal helpers
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalText = document.getElementById("modalText");
    const modalTitle = document.getElementById("modalTitle");
    const modalCancel = document.getElementById("modalCancel");
    const modalOk = document.getElementById("modalOk");

    function openModal({ title, text, onOk }) {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalBackdrop.style.display = "flex";

      const cleanup = () => {
        modalBackdrop.style.display = "none";
        modalCancel.onclick = null;
        modalOk.onclick = null;
      };

      modalCancel.onclick = () => cleanup();
      modalBackdrop.onclick = (e) => { if (e.target === modalBackdrop) cleanup(); };

      modalOk.onclick = async () => {
        cleanup();
        await onOk();
      };
    }

    async function callArchive(projectId, adminKey) {
      const u = new URL(workerBase);
      u.pathname = "/";
      u.searchParams.set("action", "archiveRepo");
      u.searchParams.set("projectId", projectId);
      u.searchParams.set("adminKey", adminKey);
      const res = await fetch(u.toString(), { cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok && !data.error, status: res.status, data };
    }

    async function loadWrikeProjects(){
      const el = document.getElementById("wrikeProjects");
      const listUrl = buildListUrl();
      el.textContent = "Loading…";

      try {
        const res = await fetch(listUrl, { cache: "no-store" });
        const data = await res.json();

        if (!res.ok || data.error) {
          el.textContent = "Error: " + (data.error || ("HTTP " + res.status));
          return;
        }

        if (!data.projects?.length) {
          el.textContent = "No matching projects found.";
          return;
        }

        el.innerHTML = data.projects.slice(0, 25).map(p => {
          const title = escapeHtml(p.title || "(Untitled project)");
          const metaParts = [];
          if (p.endDate) metaParts.push(`End ${p.endDate}`);
          if (p.repoArchived) metaParts.push("Repo archived");
          const meta = metaParts.join(" • ");

          const repoBtn = p.repoUrl
            ? `<a class="btn" href="${p.repoUrl}" target="_blank" rel="noreferrer">Repo</a>`
            : `<button class="btn" disabled>Repo</button>`;

          const canArchive = !!p.repoUrl; // only makes sense if we have a repo page
          const archiveDisabled = (p.repoArchived || !canArchive) ? "disabled" : "";
          const archiveMuted = (p.repoArchived || !canArchive) ? "muted" : "";

          return `
            <div class="item">
              <div class="left">
                <div class="text">
                  <div class="main">${title}</div>
                  <div class="meta" data-meta="${p.id}">${escapeHtml(meta)}</div>
                  <div class="statusline" data-status="${p.id}"></div>
                </div>
              </div>
              <div class="actions">
                ${repoBtn}
                <a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Open</a>
                <button class="btn btn-danger ${archiveMuted}"
                        ${archiveDisabled}
                        data-archive="${p.id}"
                        data-title="${title}">
                  Archive
                </button>
              </div>
            </div>
          `;
        }).join("");

        el.querySelectorAll("button[data-archive]").forEach(btn => {
          btn.addEventListener("click", () => {
            const projectId = btn.dataset.archive;
            const projectTitle = btn.dataset.title || "this project";
            const metaEl = el.querySelector(`[data-meta="${projectId}"]`);
            const statusEl = el.querySelector(`[data-status="${projectId}"]`);

            openModal({
              title: "Archive repo page?",
              text: `Move "${projectTitle}" repo page to the Project Archive page in Notion.`,
              onOk: async () => {
                const adminKey = getAdminKey();
                if (!adminKey) {
                  statusEl.textContent = "Missing admin key (top right).";
                  return;
                }

                btn.disabled = true;
                statusEl.textContent = "Archiving…";

                const result = await callArchive(projectId, adminKey);

                if (!result.ok) {
                  btn.disabled = false;
                  statusEl.textContent = "Archive failed: " + (result.data?.error || ("HTTP " + result.status));
                  return;
                }

                // Keep project in list; just annotate + mute button
                btn.disabled = true;
                btn.classList.add("muted");
                statusEl.textContent = "Moved to Project Archive.";

                const curr = (metaEl.textContent || "").trim();
                if (!curr.includes("Repo archived")) {
                  metaEl.textContent = curr ? `${curr} • Repo archived` : "Repo archived";
                }
              }
            });
          });
        });

      } catch (e) {
        el.textContent = "Error: " + String(e);
      }
    }

    loadWrikeProjects();
  </script>
</body>
</html>
