<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wrike Projects</title>
  <style>
    :root{
      --bg1:#120915;
      --bg2:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:#f4f4f5;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.03);
      --shadow:0 30px 80px rgba(0,0,0,.45);
      --btn:rgba(255,255,255,.10);
      --btnStroke:rgba(255,255,255,.16);
      --repo:#f5c542;
      --open:#ff4dd2;
      --archive:#ffffff;
      --badge:#ff3b30;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(255,0,214,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(255,189,74,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:24px;
    }
    .wrap{
      max-width: 980px;
      margin:0 auto;
      border:1px solid var(--stroke);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top{
      padding:22px 22px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--stroke);
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:18px;}
    .admin{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:.9;
      font-size:12px;
    }
    .admin input{
      width:240px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding:9px 12px;
      color:var(--text);
      outline:none;
    }
    .req{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      opacity:.8;
    }
    .panel{ padding: 18px 22px 24px; }
    .card{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      background: linear-gradient(180deg, var(--card), var(--card2));
    }
    .sectionTitle{
      font-weight:750;
      margin-bottom:14px;
      opacity:.92;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background: rgba(0,0,0,.18);
    }
    .meta{ min-width:0; }
    .name{
      font-weight:750;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 560px;
    }
    .sub{
      opacity:.78;
      font-size:12px;
      margin-top:4px;
    }
    .btns{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:nowrap;
    }
    .btn, a.btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:34px;
      min-width:64px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid var(--btnStroke);
      background: var(--btn);
      color: var(--text);
      text-decoration:none;
      font-weight:650;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn.repo{ border-color: rgba(245,197,66,.40); color: var(--repo); }
    .btn.open{ border-color: rgba(255,77,210,.35); color: var(--open); }
    .btn.archive{ border-color: rgba(255,255,255,.22); color: rgba(255,255,255,.92); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .badge{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width:18px;
      height:18px;
      padding:0 5px;
      border-radius:999px;
      display:none;
      align-items:center;
      justify-content:center;
      background: var(--badge);
      color:#fff;
      font-size:11px;
      font-weight:800;
      border:2px solid rgba(0,0,0,.35);
      line-height:1;
    }
    .badge.show{ display:flex; }
    .err{
      display:none;
      margin-top:12px;
      color:#fff;
      background: rgba(255,59,48,.18);
      border:1px solid rgba(255,59,48,.35);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      white-space:pre-wrap;
    }
    .footerNote{
      margin-top:14px;
      font-size:12px;
      opacity:.75;
    }
    .empty{
      opacity:.75;
      font-size:13px;
      padding:10px 12px;
      border:1px dashed var(--stroke);
      border-radius:12px;
      background: rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Wrike Projects</div>
      <div class="admin">
        <input id="adminKey" type="password" placeholder="Admin key (Archive)" />
        <span class="req">Key required</span>
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <div class="sectionTitle">My Wrike Projects</div>
        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display:none;">No projects found for your PM/Assigned fields.</div>
        <div id="err" class="err"></div>
        <div class="footerNote">
          Comment badges auto-update (polls Worker KV counts; webhook pushes updates into KV).
          <div id="whStatus" style="margin-top:6px; opacity:.75;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://wrike-proxy.dustinjsmith.workers.dev/";
    const PM_FIELD = "Project Manager";
    const ASSIGNED_FIELD = "Assigned";
    const LIMIT = 25;
    const UNREAD_POLL_MS = 20000;

    let projects = [];
    let unreadTimer = null;
    let webhookTimer = null;
    const locallyClearedAt = new Map();

    const $ = (id) => document.getElementById(id);
    const listEl = $("list");
    const errEl = $("err");
    const emptyEl = $("empty");

    const showError = (msg) => { errEl.style.display="block"; errEl.textContent=msg; };
    const clearError = () => { errEl.style.display="none"; errEl.textContent=""; };

    const apiUrl = (params) => {
      const u = new URL(WORKER_URL);
      Object.entries(params || {}).forEach(([k,v]) => u.searchParams.set(k, v));
      return u.toString();
    };

    async function fetchJson(url, init) {
      const r = await fetch(url, init);
      const text = await r.text();
      let j; try { j = JSON.parse(text); } catch { j = { raw: text }; }
      if (!r.ok) throw new Error(j?.error ? j.error : `HTTP ${r.status}: ${text}`);
      return j;
    }

    function setBadge(projectId, count) {
      const badge = document.querySelector(`[data-badge-for="${projectId}"]`);
      if (!badge) return;

      const n = Math.max(0, Number(count || 0));
      if (n > 0) {
        badge.textContent = String(Math.min(99, n));
        badge.classList.add("show");
      } else {
        badge.textContent = "";
        badge.classList.remove("show");
      }
    }

    function render() {
      listEl.innerHTML = "";
      emptyEl.style.display = projects.length ? "none" : "block";

      for (const p of projects) {
        const row = document.createElement("div");
        row.className = "row";

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = p.title || "(Untitled)";

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = p.endDate ? `End ${p.endDate}` : "";

        meta.appendChild(name);
        meta.appendChild(sub);

        const btns = document.createElement("div");
        btns.className = "btns";

        const repoBtn = document.createElement("a");
        repoBtn.className = "btn repo";
        repoBtn.textContent = "Repo";
        repoBtn.target = "_blank";
        repoBtn.rel = "noopener";
        repoBtn.href = p.repoUrl || "#";
        if (!p.repoUrl) {
          repoBtn.style.opacity = ".55";
          repoBtn.style.pointerEvents = "none";
        }

        const openBtn = document.createElement("a");
        openBtn.className = "btn open";
        openBtn.textContent = "Open";
        openBtn.href = p.link || "#";
        openBtn.target = "_blank";
        openBtn.rel = "noopener";

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.setAttribute("data-badge-for", p.id);
        openBtn.appendChild(badge);

        const markSeenNow = () => {
          const u = apiUrl({ action: "markSeen", projectId: p.id, _ts: String(Date.now()) });

          locallyClearedAt.set(p.id, Date.now());
          setBadge(p.id, 0);

          let queued = false;
          try { if (navigator.sendBeacon) queued = navigator.sendBeacon(u, ""); } catch {}

          if (!queued) {
            try { (new Image()).src = u; } catch {}
            fetch(u, { method: "POST", keepalive: true }).catch(()=>{});
          }
        };

        openBtn.addEventListener("pointerdown", markSeenNow);
        openBtn.addEventListener("click", markSeenNow);

        const archiveBtn = document.createElement("button");
        archiveBtn.className = "btn archive";
        archiveBtn.textContent = "Archive";
        archiveBtn.addEventListener("click", async () => {
          const adminKey = $("adminKey").value || "";
          if (!adminKey) return alert("Admin key required to archive.");
          archiveBtn.textContent = "Archivingâ€¦";
          archiveBtn.disabled = true;
          try {
            await fetchJson(apiUrl({ action: "archiveRepo", projectId: p.id, adminKey }), { method: "POST" });
          } catch (err) {
            alert(String(err));
          } finally {
            archiveBtn.textContent = "Archive";
            archiveBtn.disabled = false;
          }
        });

        btns.appendChild(repoBtn);
        btns.appendChild(openBtn);
        btns.appendChild(archiveBtn);

        row.appendChild(meta);
        row.appendChild(btns);
        listEl.appendChild(row);
      }
    }

    async function refreshUnreadCounts() {
      if (!projects.length) return;
      const ids = projects.map(p => p.id).join(",");
      const data = await fetchJson(apiUrl({ action: "unreadCounts", ids, _ts: String(Date.now()) }), { cache: "no-store" });
      const counts = data.counts || {};
      const now = Date.now();

      for (const p of projects) {
        let c = Number(counts[p.id] || 0);
        const clearedAt = locallyClearedAt.get(p.id) || 0;
        if (clearedAt && (now - clearedAt) < 5000) c = 0;
        if (c === 0) locallyClearedAt.delete(p.id);
        setBadge(p.id, c);
      }
    }

    async function refreshWebhookStatus() {
      const el = $("whStatus");
      if (!el) return;
      try {
        const data = await fetchJson(apiUrl({ action: "webhookStatus", _ts: String(Date.now()) }), { cache: "no-store" });
        const s = data.status;
        if (!s || !s.receivedAt) {
          el.textContent = "Webhook: no events received yet.";
          return;
        }
        const dt = new Date(s.receivedAt);
        const types = Array.isArray(s.eventTypes) ? s.eventTypes.slice(0, 4).join(", ") : "";
        el.textContent = `Webhook: last received ${dt.toLocaleString()}${types ? " (" + types + ")" : ""}`;
      } catch {
        el.textContent = "Webhook: status unavailable.";
      }
    }

    async function loadProjects() {
      clearError();
      const data = await fetchJson(apiUrl({ pmField: PM_FIELD, assignedField: ASSIGNED_FIELD, limit: String(LIMIT) }));
      projects = data.projects || [];
      render();

      await refreshUnreadCounts();
      await refreshWebhookStatus();

      if (unreadTimer) clearInterval(unreadTimer);
      unreadTimer = setInterval(refreshUnreadCounts, UNREAD_POLL_MS);

      if (webhookTimer) clearInterval(webhookTimer);
      webhookTimer = setInterval(refreshWebhookStatus, 60000);
    }

    loadProjects().catch(e => showError(String(e)));
  </script>
</body>
</html>
