<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wrike Projects</title>
  <style>
    :root{
      --bg1:#120915;
      --bg2:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:#f4f4f5;
      --muted:rgba(244,244,245,.75);
      --btnStroke:rgba(255,255,255,.14);
      --pink:#ff4d9d;
      --shadow:0 16px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 15% 8%, rgba(255,77,157,.24), transparent 60%),
        radial-gradient(900px 520px at 85% 15%, rgba(245,197,66,.18), transparent 60%),
        radial-gradient(900px 520px at 70% 80%, rgba(120,200,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:18px;
    }
    .shell{
      max-width:980px;
      margin:0 auto;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
    }
    .title{font-weight:800; letter-spacing:.2px;}
    .panel{padding:16px 18px 18px;}
    .card{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      padding:14px;
    }
    .sectionTitle{
      font-size:13px;
      color:var(--muted);
      margin:0 0 10px 0;
      font-weight:700;
    }
    .list{display:flex; flex-direction:column; gap:10px;}
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .meta{min-width:0;}
    .name{
      font-weight:800; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:720px;
    }
    .sub{margin-top:4px; font-size:12px; color:var(--muted);}
    .btns{display:flex; align-items:center; gap:10px; flex-shrink:0;}
    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--btnStroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.10)}
    .btn:active{transform:translateY(1px)}
    .btn.open{
      background:rgba(255,77,157,.14);
      border-color:rgba(255,77,157,.34);
      color:#ffd1e5;
    }
    .err{
      margin-top:10px;
      font-size:12px;
      color:#ffb4b4;
      display:none;
      white-space:pre-wrap;
    }
    .empty{
      padding:10px;
      color:var(--muted);
      font-size:12px;
    }
    .footerNote{margin-top:10px; font-size:12px; color:var(--muted);}
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="title">Wrike Projects</div>
      <div style="font-size:12px;color:rgba(244,244,245,.7);font-weight:700;">ASU Outreach Hub</div>
    </div>

    <div class="panel">
      <div class="card">
        <div class="sectionTitle">My Wrike Projects</div>
        <div id="list" class="list"></div>
        <div id="err" class="err"></div>
        <div class="footerNote">
          Showing projects where you are Project Manager (custom field) or assigned to at least one task (responsible).
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const WORKER_URL = "https://wrike-proxy.dustinjsmith.workers.dev/";
    const PM_FIELD = "Project Manager";
    const LIMIT = 25;

    // Optional: if you want to force a Space scope from the widget side,
    // paste the spaceId here. Otherwise leave blank and (recommended) set DEFAULT_SPACE_ID in Worker.
    const SPACE_ID = "";

    const $ = (id) => document.getElementById(id);
    const listEl = $("list");
    const errEl = $("err");

    const showError = (msg) => { errEl.style.display="block"; errEl.textContent=msg; };
    const clearError = () => { errEl.style.display="none"; errEl.textContent=""; };

    const apiUrl = (params) => {
      const u = new URL(WORKER_URL);
      Object.entries(params || {}).forEach(([k,v]) => {
        if (v === undefined || v === null || v === "") return;
        u.searchParams.set(k, v);
      });
      return u.toString();
    };

    async function fetchJson(url) {
      const r = await fetch(url, { cache: "no-store" });
      const text = await r.text();
      let j; try { j = JSON.parse(text); } catch { j = { raw: text }; }
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
      return j;
    }

    function render(projects) {
      listEl.innerHTML = "";

      if (!projects || !projects.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No projects returned. (If this seems wrong, test the Worker endpoint with ?action=whoami and check the meta block.)";
        listEl.appendChild(empty);
        return;
      }

      for (const p of projects) {
        const row = document.createElement("div");
        row.className = "row";

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = p.title || "(Untitled)";

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = p.endDate ? `End ${p.endDate}` : "";

        meta.appendChild(name);
        meta.appendChild(sub);

        const btns = document.createElement("div");
        btns.className = "btns";

        const openBtn = document.createElement("a");
        openBtn.className = "btn open";
        openBtn.textContent = "Open";
        openBtn.href = p.link || "#";
        openBtn.target = "_blank";
        openBtn.rel = "noopener";

        btns.appendChild(openBtn);

        row.appendChild(meta);
        row.appendChild(btns);
        listEl.appendChild(row);
      }
    }

    async function load() {
      clearError();

      const params = {
        pmField: PM_FIELD,
        limit: String(LIMIT),
      };
      if (SPACE_ID) params.spaceId = SPACE_ID;

      const data = await fetchJson(apiUrl(params));
      render(data.projects || []);
    }

    load().catch(e => showError(String(e)));
  </script>
</body>
</html>
