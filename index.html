<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wrike Projects</title>

  <!-- Helps reduce caching weirdness in embeds -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --asu-maroon:#8C1D40;
      --asu-gold:#FFC627;

      --bg0:#0b0f17;
      --bg1:#0f1320;
      --card:rgba(255,255,255,0.06);
      --card2:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.12);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.70);
      --muter:rgba(255,255,255,0.55);
      --shadow: 0 14px 40px rgba(0,0,0,0.45);
      --radius:18px;
      --font: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 380px at 10% 0%, rgba(140,29,64,0.35), transparent 55%),
        radial-gradient(780px 360px at 95% 10%, rgba(255,198,39,0.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
    }

    .wrap{ padding:18px; }

    .card{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.18);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:16px 18px 10px 18px;
    }

    .title{
      font-size:26px;
      font-weight:800;
      letter-spacing:0.2px;
      margin:0 0 10px 0;
      color:var(--asu-gold);
    }

    .rule{
      height:2px;
      width:100%;
      background:linear-gradient(90deg, var(--asu-gold), rgba(255,198,39,0.18));
      opacity:0.95;
    }

    .content{ padding:14px 18px 18px 18px; }

    .statusRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:13px;
      line-height:1;
    }

    .dot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(255,255,255,0.28);
    }

    .dot.ok{ background:rgba(0,255,170,0.55); }
    .dot.bad{ background:rgba(255,80,80,0.70); }
    .dot.load{ background:rgba(255,198,39,0.85); }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .item{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.05));
    }

    .left{ min-width:0; }
    .name{
      font-size:14px;
      font-weight:750;
      margin:0 0 8px 0;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 850px;
    }

    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badge{
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);
      color:var(--muted);
    }

    .badge.maroon{
      border-color: rgba(140,29,64,0.55);
      background: rgba(140,29,64,0.18);
      color: rgba(255,255,255,0.92);
    }

    .badge.gold{
      border-color: rgba(255,198,39,0.55);
      background: rgba(255,198,39,0.12);
      color: rgba(255,255,255,0.92);
    }

    a.open{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      color:rgba(255,255,255,0.92);
      text-decoration:none;
      font-weight:700;
      white-space:nowrap;
    }
    a.open:hover{ background:rgba(255,255,255,0.08); }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muter);
    }

    .errorBox{
      border:1px solid rgba(255,80,80,0.45);
      background: rgba(255,80,80,0.10);
      padding:10px 12px;
      border-radius:14px;
      color: rgba(255,255,255,0.92);
      font-size:13px;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1 class="title">Wrike Projects</h1>
        <div class="rule"></div>
      </div>

      <div class="content">
        <div class="statusRow">
          <div class="pill" id="statePill"><span class="dot load"></span><span id="stateText">Starting…</span></div>
          <div class="pill"><span class="dot"></span><span id="userText">—</span></div>
        </div>

        <div id="main"></div>

        <div class="hint">
          Tip: You can force-refresh by adding <code>?v=</code> to the URL (e.g. <code>?v=2</code>) to bust embed caching.
        </div>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // If you want to hardcode your Worker, replace DEFAULT_WORKER below.
    const DEFAULT_WORKER =
      "https://wrike-proxy.dustinjsmith.workers.dev/?pmField=Project+Manager&assignedField=Assigned&limit=25";

    // Allow overriding via URL param: ?worker=https://... (URL-encoded)
    function getWorkerUrl() {
      const params = new URLSearchParams(location.search);
      const override = params.get("worker");
      const base = override ? override : DEFAULT_WORKER;

      // Cache-bust every time to avoid stale results in Notion embeds
      const u = new URL(base);
      u.searchParams.set("t", Date.now().toString());
      return u.toString();
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setState(kind, text) {
      const pill = document.getElementById("statePill");
      const dot = pill.querySelector(".dot");
      dot.className = "dot " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "load");
      document.getElementById("stateText").textContent = text;
    }

    function renderError(errText) {
      const main = document.getElementById("main");
      main.innerHTML = `<div class="errorBox">${esc(errText)}</div>`;
    }

    function renderProjects(data) {
      const main = document.getElementById("main");
      const projects = Array.isArray(data?.projects) ? data.projects : [];
      const userName = data?.user?.name ? data.user.name : "Unknown user";
      document.getElementById("userText").textContent = userName;

      if (!projects.length) {
        main.innerHTML = `<div class="errorBox">No projects returned.</div>`;
        return;
      }

      const items = projects.map(p => {
        const title = esc(p.title);
        const status = esc(p.status || "—");
        const roles = Array.isArray(p.roles) ? p.roles : [];
        const url = esc(p.openUrl || "#");

        const roleBadges = roles.map(r => {
          const cls = (r === "PM") ? "badge maroon" : "badge gold";
          return `<span class="${cls}">${esc(r)}</span>`;
        }).join("");

        return `
          <div class="item">
            <div class="left">
              <div class="name" title="${title}">${title}</div>
              <div class="meta">
                <span class="badge">${status}</span>
                ${roleBadges}
              </div>
            </div>
            <div class="right">
              <a class="open" href="${url}" target="_blank" rel="noopener noreferrer">Open in Wrike ↗</a>
            </div>
          </div>
        `;
      }).join("");

      main.innerHTML = `<div class="list">${items}</div>`;
    }

    async function init() {
      try {
        setState("load", "Fetching projects you’re involved in…");

        const workerUrl = getWorkerUrl();
        console.log("[Wrike Widget] Worker URL:", workerUrl);

        const res = await fetch(workerUrl, { cache: "no-store" });
        console.log("[Wrike Widget] Response status:", res.status);

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`Worker returned ${res.status}\n\n${txt}`);
        }

        const data = await res.json();
        console.log("[Wrike Widget] Data:", data);

        if (!data || data.ok !== true) {
          throw new Error(`Unexpected payload:\n\n${JSON.stringify(data, null, 2)}`);
        }

        renderProjects(data);
        setState("ok", `Loaded ${data.projects?.length ?? 0} projects`);
      } catch (e) {
        console.error("[Wrike Widget] Error:", e);
        setState("bad", "Failed to load projects");
        renderError(e?.message || String(e));
      }
    }

    // Ensures DOM exists before script runs (prevents “container not found” hangs)
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
